<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Web & Bot Marketplace</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2, h3 { margin-top: 0; }
        label { font-weight: bold; font-size: 14px; display: block; margin-top: 10px; }
        input, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #0088cc; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; width: 100%; }
        button:hover { background-color: #006699; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        #log { background: #222; color: #0f0; padding: 10px; height: 150px; overflow-y: scroll; font-family: monospace; font-size: 12px; border-radius: 5px; margin-top: 10px; }
        .list-item { background: #f9f9f9; border: 1px solid #ddd; padding: 10px; margin-top: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .peringatan { color: #dc3545; font-size: 13px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="text-align: center;">Control Panel Bot (1 File)</h2>
        <p class="peringatan">‚ö†Ô∏è Jangan tutup tab browser ini agar bot tetap menyala merespons pelanggan!</p>

        <div class="card">
            <h3>1. Status Bot</h3>
            <label>Token Bot Telegram:</label>
            <input type="text" id="botToken" value="8614978857:AAEn_6YWeJquoP9Qpj5XKEs9IO2BQYGUs2E">
            
            <button onclick="mulaiBot()" id="btnMulai">‚ñ∂ Nyalakan Bot Sekarang</button>
            <button onclick="matikanBot()" id="btnMati" class="btn-danger" style="display:none;">‚èπ Matikan Bot</button>
        </div>

        <div class="card">
            <h3>2. Tambah Fitur / Menu Bot</h3>
            <label>Perintah (Contoh: /promo atau harga):</label>
            <input type="text" id="cmd" placeholder="Ketik perintah dari user...">
            
            <label>Balasan Bot:</label>
            <textarea id="reply" rows="3" placeholder="Ketik balasan bot di sini..."></textarea>
            
            <button onclick="simpanFitur()" style="background-color: #28a745;">üíæ Simpan ke Database Web</button>
        </div>

        <div class="card">
            <h3>3. Fitur yang Sedang Aktif</h3>
            <div id="listFitur"></div>
        </div>

        <div class="card">
            <h3>Terminal Log (Live)</h3>
            <div id="log">Sistem siap...<br></div>
        </div>
    </div>

    <script>
        let botInterval;
        let lastUpdateId = 0;

        // Mengambil data fitur dari LocalStorage (Database di dalam Browser)
        let databaseFitur = JSON.parse(localStorage.getItem('database_bot_marketplace')) || [
            { command: '/start', reply: 'Halo! Selamat datang di Marketplace kami.' }
        ];

        // Fungsi Menampilkan Daftar Fitur di Web
        function renderFitur() {
            const list = document.getElementById('listFitur');
            list.innerHTML = '';
            if(databaseFitur.length === 0) list.innerHTML = '<p style="font-size:12px; color:#666;">Belum ada fitur ditambahkan.</p>';
            
            databaseFitur.forEach((item, index) => {
                list.innerHTML += `
                    <div class="list-item">
                        <div><b>${item.command}</b> <br> <span style="font-size:12px; color:#555;">${item.reply}</span></div>
                        <button class="btn-danger" style="width:auto; padding:5px 10px; margin:0;" onclick="hapusFitur(${index})">Hapus</button>
                    </div>`;
            });
        }

        // Fungsi Menyimpan Fitur Baru
        function simpanFitur() {
            const cmd = document.getElementById('cmd').value;
            const reply = document.getElementById('reply').value;
            
            if(!cmd || !reply) return alert("Perintah dan Balasan harus diisi!");
            
            databaseFitur.push({ command: cmd, reply: reply });
            localStorage.setItem('database_bot_marketplace', JSON.stringify(databaseFitur));
            
            document.getElementById('cmd').value = '';
            document.getElementById('reply').value = '';
            
            renderFitur();
            tulisLog(`‚úÖ Fitur '${cmd}' berhasil ditambahkan!`);
        }

        // Fungsi Menghapus Fitur
        function hapusFitur(index) {
            databaseFitur.splice(index, 1);
            localStorage.setItem('database_bot_marketplace', JSON.stringify(databaseFitur));
            renderFitur();
            tulisLog(`üóëÔ∏è Fitur dihapus.`);
        }

        // Fungsi Terminal Log
        function tulisLog(pesan) {
            const logDiv = document.getElementById('log');
            const waktu = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${waktu}] ${pesan}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // ==========================================
        // MESIN BOT TELEGRAM (LONG POLLING)
        // ==========================================

        function mulaiBot() {
            const token = document.getElementById('botToken').value;
            if(!token) return alert("Token tidak boleh kosong!");

            document.getElementById('btnMulai').style.display = 'none';
            document.getElementById('btnMati').style.display = 'block';
            tulisLog("üöÄ Bot dinyalakan. Memantau pesan masuk...");

            // Cek pesan baru setiap 1.5 detik
            botInterval = setInterval(() => tarikPesan(token), 1500);
        }

        function matikanBot() {
            clearInterval(botInterval);
            document.getElementById('btnMulai').style.display = 'block';
            document.getElementById('btnMati').style.display = 'none';
            tulisLog("üõë Bot dimatikan.");
        }

        async function tarikPesan(token) {
            try {
                const response = await fetch(`https://api.telegram.org/bot${token}/getUpdates?offset=${lastUpdateId + 1}`);
                const data = await response.json();

                if (data.ok && data.result.length > 0) {
                    for (let update of data.result) {
                        lastUpdateId = update.update_id;

                        if (update.message && update.message.text) {
                            const chatId = update.message.chat.id;
                            const teksUser = update.message.text;
                            
                            tulisLog(`üí¨ Pesan dari ID ${chatId}: ${teksUser}`);

                            // Bot mencari jawaban di "Database"
                            const cariFitur = databaseFitur.find(f => f.command.toLowerCase() === teksUser.toLowerCase());

                            if (cariFitur) {
                                balasPesan(token, chatId, cariFitur.reply);
                            } else {
                                balasPesan(token, chatId, "Maaf, perintah tidak dikenali oleh sistem.");
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Koneksi terputus:", error);
            }
        }

        async function balasPesan(token, chatId, teksBalasan) {
            try {
                await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: chatId, text: teksBalasan })
                });
                tulisLog(`ü§ñ Bot membalas: ${teksBalasan}`);
            } catch (error) {
                tulisLog(`‚ùå Gagal mengirim pesan ke ${chatId}`);
            }
        }

        // Tampilkan fitur saat web pertama kali dibuka
        renderFitur();
    </script>
</body>
</html>
